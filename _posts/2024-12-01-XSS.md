---
title: "Cross Site Scripting"
excert: "XSS"
categories:
  - sec
tags:
  - xss
  - cross site scripting
  - Stored XSS
  - reflected XSS
  - html tag
last_modified_at: 2024-12-01T23:59:59+09:00

toc_label: I.N.D.E.X
toc: true
toc_sticky: true

author_profile: false
sitemap :
  changefreq : daily
  priority : 1.0
---

# XSS(Cross Site Scripting)

XSS란 공격 대상에게 script를 보내 실행 시키는 공격으로 가장 기초적이지만 SQL Injection과 함께 많이 발견되는 취약점 중 하나이다.

간단한 예를 들자면 게시글을 작성 하는 곳에
```javascript
title
선생님 질문이 있습니다.

post
저는 코나타가 좋습니다. 하지만 유키도 포기 할 수 없죠.
<script> console.log("사실 전 G41이 좋아요"); </script>
하지만 요즘 저를 끌리게 하는 것이 있는데 그것은
```

위의 형식과 비슷한 게시물을 누군가 작성했고 해당 사이트가 XSS에 대비 되어 있지 않다고 가정해보자 그러면 실제 게시물에 보이는 것은

```text
저는 코나타가 좋습니다. 하지만 유키도 포기 할 수 없죠.
하지만 요즘 저를 끌리게 하는 것이 있는데 그것은
```

이런식으로 보이겠지만 개발자 도구를 켜서 확인해 보면 

> 사실 전 G41이 좋아요

이런 로그가 찍혀 있을 것이다 이것이 XSS이다.

# XSS의 종류

XSS는 Stored XSS 방식과 reflected XSS이 있다.

## Stored XSS

Stored XSS 방식은 저장소를 이용하는 방식으로 위에 예시로 든 내용과 비슷하게 게시글 등을 작성하여 저장소에 저장 후 해당 내용을 보는 상대에게 공격을 가한다.

## reflected XSS

URL 파라메터에 스크릅트를 넣어 저장소에 저장하지 않고 바로 스크립트를 작동 하도록 하는 방식으로 피싱메일 등에 사용 되는 방식이다.

# 공격방법

저장소 방식이든 저장소를 이용하지 않는 방식이든 공통점은 스크립트를 넣어 공격 하는 방식으로 html을 대상으로 하기에 javascript가 주로 사용된다.

## 기본형

예제와 같이 <scropt> 공격문 </script> 형태로 직접 집어넣는 방식이다. 하지만 이런 방식은 너무 기본적인 것이라 거의 당하지 않는다.(하지만 실제 현장에서 먹히는 곳이 종종 있는거 보묜 무섭다... 나 인턴 시작한지 2달 밖에 안되었는데... react나 vue.js 하다못해 fastapi같은것만 써도 이스케이프화를 진행하고 문자열로 취급해서 막아주는 것으로 알고 있는데...) 

## img 태그 이용

img태그의 특징은 src를 통해 경로에 있는 이미지를 가져오는데 여기서 src 값에 script를 넣으면 작동 할 때가 있다.물론 이는 구식 브라우저에서 주로 사용되던 방식이거나 검증이 너무 미흡한 경우로 이미지 경로를 처리할 때 스크립트도 같이 처리하면서 생기는 방식이다.

요즘에 자주 쓰이는 방식은
``` javascript
<img src=wrong onerror=스크립트 />
```
형태라고 한다.

작동 방식은 간단하게 img를 불러오지 못하는 상황에서 어떻게 처리해야 하는지 작동하는 onerror을 이용하여 작동하는 방식으로 여기서 프론트 개발을 해봤다면 알겠지만 스크립트 함수를 작성해서 실행시킬 수 있다.

간단하게

```
<img src='/asdf' onerror="alert('A~!')"/>
```
와 같이 입력하면 이미지를 불러 올 수 있는 상황이면 이미지를 불러 올 수 없는 상황에는 A~!라는 메세지가 출력 될 것이다.

이를 이용하여 img태그에 이상한 경로를 집어 넣어 오류를 발생 시키고 스크립트를 동작시키는 방식의 공격이 되겠다.

여기서는 자주 사용되고 쉽게 쓸 수 있는 것이 img라 그렇지 다양한 태그들이 가능하다.

## 난독화

html encoding, base64등 인코딩을 통해 그대로는 읽을 수 없지만 html이 작동할 때 decoding을 진행시켜주어서 작동 할 수 있게 하는 방식이다.

```javascript
atob('YWxlcnQoJ0F+MScpOw==');
```

이것을 실행하면 alert('A~!'); 가 나온다 이런것 처럼 인코딩과 디코딩을 통해 스크립트를 숨기고 문자열을 실행하는 new Function, eval 등을 이용해 공격을 진행하는 방식이다.

여기서 좀 특이한 버전도 있는데

``` text
ﾟωﾟﾉ= /｀ｍ´）ﾉ ~┻━┻   //*´∇｀*/ ['_']; o=(ﾟｰﾟ)  =_=3; c=(ﾟΘﾟ) =(ﾟｰﾟ)-(ﾟｰﾟ); (ﾟДﾟ) =(ﾟΘﾟ)= (o^_^o)/ (o^_^o);(ﾟДﾟ)={ﾟΘﾟ: '_' ,ﾟωﾟﾉ : ((ﾟωﾟﾉ==3) +'_') [ﾟΘﾟ] ,ﾟｰﾟﾉ :(ﾟωﾟﾉ+ '_')[o^_^o -(ﾟΘﾟ)] ,ﾟДﾟﾉ:((ﾟｰﾟ==3) +'_')[ﾟｰﾟ] }; (ﾟДﾟ) [ﾟΘﾟ] =((ﾟωﾟﾉ==3) +'_') [c^_^o];(ﾟДﾟ) ['c'] = ((ﾟДﾟ)+'_') [ (ﾟｰﾟ)+(ﾟｰﾟ)-(ﾟΘﾟ) ];(ﾟДﾟ) ['o'] = ((ﾟДﾟ)+'_') [ﾟΘﾟ];(ﾟoﾟ)=(ﾟДﾟ) ['c']+(ﾟДﾟ) ['o']+(ﾟωﾟﾉ +'_')[ﾟΘﾟ]+ ((ﾟωﾟﾉ==3) +'_') [ﾟｰﾟ] + ((ﾟДﾟ) +'_') [(ﾟｰﾟ)+(ﾟｰﾟ)]+ ((ﾟｰﾟ==3) +'_') [ﾟΘﾟ]+((ﾟｰﾟ==3) +'_') [(ﾟｰﾟ) - (ﾟΘﾟ)]+(ﾟДﾟ) ['c']+((ﾟДﾟ)+'_') [(ﾟｰﾟ)+(ﾟｰﾟ)]+ (ﾟДﾟ) ['o']+((ﾟｰﾟ==3) +'_') [ﾟΘﾟ];(ﾟДﾟ) ['_'] =(o^_^o) [ﾟoﾟ] [ﾟoﾟ];(ﾟεﾟ)=((ﾟｰﾟ==3) +'_') [ﾟΘﾟ]+ (ﾟДﾟ) .ﾟДﾟﾉ+((ﾟДﾟ)+'_') [(ﾟｰﾟ) + (ﾟｰﾟ)]+((ﾟｰﾟ==3) +'_') [o^_^o -ﾟΘﾟ]+((ﾟｰﾟ==3) +'_') [ﾟΘﾟ]+ (ﾟωﾟﾉ +'_') [ﾟΘﾟ]; (ﾟｰﾟ)+=(ﾟΘﾟ); (ﾟДﾟ)[ﾟεﾟ]='\\'; (ﾟДﾟ).ﾟΘﾟﾉ=(ﾟДﾟ+ ﾟｰﾟ)[o^_^o -(ﾟΘﾟ)];(oﾟｰﾟo)=(ﾟωﾟﾉ +'_')[c^_^o];(ﾟДﾟ) [ﾟoﾟ]='\"';(ﾟДﾟ) ['_'] ( (ﾟДﾟ) ['_'] (ﾟεﾟ+(ﾟДﾟ)[ﾟoﾟ]+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (ﾟｰﾟ)+ ((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((o^_^o) +(o^_^o))+ (ﾟｰﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (c^_^o)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ (c^_^o)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟΘﾟ)+ ((ﾟｰﾟ) + (o^_^o))+ ((o^_^o) +(o^_^o))+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟεﾟ]+(ﾟｰﾟ)+ ((o^_^o) - (ﾟΘﾟ))+ (ﾟДﾟ)[ﾟεﾟ]+((ﾟｰﾟ) + (ﾟΘﾟ))+ (ﾟΘﾟ)+ (ﾟДﾟ)[ﾟoﾟ]) (ﾟΘﾟ)) ('_');
```

이것은 일본어를 이용한 이모티콘 형식을 이용하여 난독화를 진행한 공격 방식이다.

## URL Parameter

피싱메일등에도 사용되는 것으로 파라메터에 스크립트를 넣는 것이다.

> localhost:443/< img src="alert('A~!');"/>

이런 링크를 보내고 누르면 파라메터에 있는 스크립트가 작동되게 하는 방식이다.(물론 이런거 말고 피싱 사이트로 보내지 보통은...)

## 실적용...?

실제 직장에서 사용한 것을 그대로 보여줄 수는 없고 모 사이트에서 해본 것을 보여주겠다.

<img src="/assets/images/XSS/dream.png" onerror="alert('A~!');">

모 유명한 워게임 사이트에서 테스트 하는 곳이다. 파라메터에 스크립트를 넣었다. 끝!

# 방어방법

우선적으로 특수문자를 처리하여 스크립트를 동작시키지 않는 방법이 가장 손쉽고 확실한 방법이다. 위에서 이야기 했듯이 react나 vue.js 아니면 python계통 웹프레임워크에서 사용하는 orm등이 입력 받은 값을 이스케이프 처리하여 문자열로 취급 스크립트건 SQL이건 작동 안되도록 하는 장치이다.

두번쨰로 화이트리스트이다.
블랙리스트로 안되는 것이야 할 수 있지만 많기도 하고 어떤게 뭔 짓을 벌일지 모른다.  
그러니 확실하거나 필요한 것들만 허용 하는 방식인 화이트 리스트를 사용 하여 불필요하거나 위험한 것들을 적용하지 못하게 하는 방식이다.

> 블랙리스트 : 사용 하지 못하게 하는 것들의 리스트를 작성하여 해당 리스트에 해당되는 것은 사용 못함
> 화이트리스트 : 사용해도 되는 것을 정의하여 해당 리스트 내에 있는 것들만 쓸 수 있음

# 후기

뭔가 쉬운줄 알았던 XSS가 뭔가 다양하고 치밀하게 있던 것을 알고 이거 어떻게 적용 해야 하는지 몰랏다... 아직도 모르겠다... 근데 어떻게 뚫은거지.. 나??? 물론 다 배포 전 개발 태스트 단계라 하지만 기본으로... 크흠... 그렇다고 한다. 끝

:wq